set -xe

source map-integration-testing/ci/routing/common_functions.sh

set_env_var_if_not_set TOPIC ${GERRIT_TOPIC}
set_env_var_if_not_set AWS_DEFAULT_REGION us-east-1
set_env_var_if_not_set BUCKET mitf-artifacts

case ${TOPIC} in
    "FORMAT8_HLS_ROUTING_MAP_VERSION"* )
        MAP_CFG='map_format8_brf.config'
        MAP_FORMAT="BRF"
        source ${WORKSPACE}/map-config/${MAP_CFG} && MAP_VERSION=${map_version}; BRF_VERSION=${brf_compiler_version}
        ACC_ARTIFACTS_DIR=${MAP_FORMAT}_${MAP_VERSION}_${BRF_VERSION}
        ;;
    * )
        echo "ERROR: TOPIC=${TOPIC} is not supported"
        exit 1
        ;;
esac

if [[ ! -d ${WORKSPACE}/robot_specs ]]; then
    mkdir ${WORKSPACE}/robot_specs
fi

source_docker_cfg map-integration-testing/ci/routing/docker_acc.cfg && DOCKER_IMAGE=${MITF_IMAGE}

docker pull ${DOCKER_IMAGE}

trap "{ [[ -z '${BUILD_TAG}' ]] ||
        docker ps -aq --filter name=${BUILD_TAG} |
        xargs --no-run-if-empty docker rm -f --volumes ||
        true;
        } &> /dev/null" EXIT

aws s3 cp s3://${BUCKET}/mitf/acc/${ACC_ARTIFACTS_DIR}/robot_specs.tgz ${WORKSPACE}/robot_specs.tgz
tar -xvf ${WORKSPACE}/robot_specs.tgz -C ${WORKSPACE}/robot_specs
#TODO: How we identify the actual xUnit Report?
aws s3 cp s3://${BUCKET}/mitf/acc/${ACC_ARTIFACTS_DIR}/xunit.xml ${WORKSPACE}/xunit.xml

docker run --env ACC_TESTS_PATH="tools/test/share/spec" \
           --env PYTHONPATH="/workspace/map-integration-testing" \
           --env AWS_DEFAULT_REGION \
           --name "${BUILD_TAG}" \
           --interactive \
           --rm \
           --user "bldadmin" \
           --volume "${WORKSPACE}:/workspace" \
           --workdir "/workspace" \
           ${DOCKER_IMAGE} bash -esux << "EOS"
           python3 map-integration-testing/ci/routing/acceptance/convert_xunit_report.py -d xunit.xml \
                                                                                         -b converted_xunit.xml
           python3 map-integration-testing/ci/routing/acceptance/report_analyzer.py -r converted_xunit.xml \
                                                                                     -s robot_specs/international \
                                                                                     -o ${ACC_TESTS_PATH}/international \
                                                                                     -f updated_libs
           python3 map-integration-testing/ci/routing/acceptance/acceptance_tests_updater_prod.py --libs updated_libs \
                                                                                                  --sources ${ACC_TESTS_PATH}/international

EOS

./map-integration-testing/ci/routing/push_robot_files.sh
