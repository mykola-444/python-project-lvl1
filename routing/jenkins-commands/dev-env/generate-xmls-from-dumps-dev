# download build artifact from mos.cci
if [ $MAP_FORMAT == "F8" ]; then
    wget --tries=3 --timeout=120 https://mos.cci.in.here.com/job/$SERVER_BUILD_JOB/$SERVER_BUILD_NUMBER/s3/download/build/test_routing_component.tgz
    tar xf test_routing_component.tgz
elif [ $MAP_FORMAT == "BRF2" ]; then
    wget --tries=3 --timeout=120 https://hls.cci.in.here.com/job/hls_routing/job/psv/job/build/job/$SERVER_BUILD_JOB/$SERVER_BUILD_NUMBER/s3/download/build/routing-hls.tar.gz
    tar xf routing-hls.tar.gz
elif [[ $MAP_FORMAT == "NDS_SPARTA" ]]; then
    wget --tries=3 --timeout=120 https://corenav.cci.in.here.com/job/$CLIENT_BUILD_JOB/$CLIENT_BUILD_NUMBER/s3/download/build/test_routing_component.tgz
    tar xf test_routing_component.tgz
elif [[ $MAP_FORMAT == *"NDS_"* ]]; then
    wget --tries=3 --timeout=120 https://mos.cci.in.here.com/job/$CLIENT_BUILD_JOB/$CLIENT_BUILD_NUMBER/s3/download/build/test_routing_component.tgz
    tar xf test_routing_component.tgz
else
    echo "ERROR: Undetermined MAP_FORMAT=$MAP_FORMAT"
    exit 1
fi

mkdir mitf_dumps
tar xf tests.tgz -C mitf_dumps

# List all xml files - for debug only
dump_number=$(find ./mitf_dumps -type f | wc -l)
echo "INFO: Dumps number: $dump_number"

echo "Running tests using downloaded dumps"

if [[ $MAP_FORMAT == NDS_SPARTA ]]; then
    . map-integration-testing/ci/routing/docker.cfg
    DOCKER_IMAGE=$SPARTA_IMAGE
elif [[ $MAP_FORMAT == "BRF2" ]]; then
    DOCKER_IMAGE=docker-local.artifactory.in.here.com/cci/hls/routing.runtime:amzn2-gcc7.3-1.4-de81333
else
    . map-integration-testing/ci/routing/common_functions.sh
    . map-integration-testing/ci/routing/docker.cfg
    if [[ $MAP_FORMAT == NDS* ]]; then
        DOCKER_IMAGE=$DOCKER_IMAGE_MITF_32
    else
        DOCKER_IMAGE=$DOCKER_IMAGE_MITF
    fi
fi
docker pull $DOCKER_IMAGE
trap "{ [ -z $BUILD_TAG ] || docker ps -aq --filter name=$BUILD_TAG | xargs --no-run-if-empty docker rm -f --volumes || true; } &> /dev/null" EXIT
docker run \
    --env=PYTHONPATH=/workspace/map-integration-testing \
    --env=LD_LIBRARY_PATH=/workspace/installdir/lib \
    --env=MAP_PATH_PREFIX=$MAP_PATH_PREFIX \
    --env=MAP_FORMAT=$MAP_FORMAT \
    --env=LDM_REGION_DVN=$LDM_REGION_DVN \
    --env=MITF_PATH=/workspace \
    --env=GENERATE_SUCCESS_GEO_NODES=$GENERATE_SUCCESS_GEO_NODES \
    --env=SUCCESS_GEO_NODES_RUNNER=$SUCCESS_GEO_NODES_RUNNER \
    --env=DESIRED_TC_QTY=$DESIRED_TC_QTY \
    --env=GENERATORS=$GENERATORS \
    --interactive \
    --name=$BUILD_TAG \
    --net=host \
    --rm \
    --volume=$MAP_PATH_PREFIX:$MAP_PATH_PREFIX:ro \
    --volume=$WORKSPACE:/workspace \
    --volume=$HOME/.aws:/workspace/.aws:ro \
    --volume=$HOME/.aws:$HOME/.aws:ro \
    --workdir=/workspace \
    $DOCKER_IMAGE bash -esux << "EOS"
    sh map-integration-testing/ci/routing/install.sh
    map-integration-testing/ci/routing/generate_xmls_from_dumps.sh
    ls /workspace/tests_output/
    python3 map-integration-testing/ci/routing/generate_ref_client_links_from_xmls.py \
      --test_data_path /workspace/tests_output/ \
      --template map-integration-testing/utils/web/templates/ref_client_links.j2 \
      --output index_ref.html
EOS
