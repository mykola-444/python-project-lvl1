. map-integration-testing/ci/routing/common_functions.sh
source_docker_cfg map-integration-testing/ci/routing/docker.cfg
docker pull $DOCKER_IMAGE
trap "{ [ -z $BUILD_TAG ] || docker ps -aq --filter name=$BUILD_TAG | xargs --no-run-if-empty docker rm -f --volumes || true; } &> /dev/null" EXIT

docker run \
    --env MAP_FORMAT=$MAP_FORMAT \
    --env REGIONS=$REGIONS \
    --env AWS_DEFAULT_REGION=us-east-1 \
    --name=$BUILD_TAG \
    --interactive \
    --rm \
    --user=bldadmin \
    --volume=$WORKSPACE:/workspace \
    --workdir=/workspace \
    $DOCKER_IMAGE bash -esux << "EOS"
    set -a
    # map format processing
    case $MAP_FORMAT in
        "F8" )
            MAP_CFG=map-config/map_format8.config ;;
        "NDS_OLYMPIA" )
            MAP_CFG=map-config/map_nds.config ;;
        "NDS_STANDARD" )
            MAP_CFG=map-config/map_nds_standard.config ;;
        "NDS_MOTEGI" )
            MAP_CFG=map-config/map_nds_vanilla.config ;;
    esac
    python3 ./map-integration-testing/ci/routing/get_dvn_list.py --map_config $MAP_CFG --regions $REGIONS
EOS

# Get information about latest succesfull artifacts from post-submit verification
wget https://mos.cci.in.here.com/job/MOS_dal-submit-verify-trigger/lastSuccessfulBuild/artifact/buildinfo.txt
source buildinfo.txt

if $USE_CUSTOM_SERVER_BUILD ; then
    echo "Using custom server build"
    echo SERVER_BUILD_JOB=$CUSTOM_SERVER_BUILD_JOB >> envs
    # if CUSTOM_SERVER_BUILD_JOB_NUMBER is not number get the build number
    if ! [[ $CUSTOM_SERVER_BUILD_JOB_NUMBER =~ '^[0-9]+$' ]]; then
        CUSTOM_SERVER_BUILD_JOB_NUMBER=$(curl -s https://mos.cci.in.here.com/job/$CUSTOM_SERVER_BUILD_JOB/$CUSTOM_SERVER_BUILD_JOB_NUMBER/buildNumber)
    fi
    echo SERVER_BUILD_NUMBER=$CUSTOM_SERVER_BUILD_JOB_NUMBER >> envs
else
    echo "Using default server build"
    echo SERVER_BUILD_JOB=$BUILD_JOB_lin64_rel_routing_server >> envs
    echo SERVER_BUILD_NUMBER=$BUILD_NUMBER_lin64_rel_routing_server >> envs
fi

if $USE_CUSTOM_CLIENT_BUILD ; then
    echo "Using custom client build"
    echo CLIENT_BUILD_JOB=$CUSTOM_CLIENT_BUILD_JOB >> envs
    # if CUSTOM_CLIENT_BUILD_JOB_NUMBER is not number get the build number
    if ! [[ $CUSTOM_CLIENT_BUILD_JOB_NUMBER =~ '^[0-9]+$' ]]; then
        CUSTOM_CLIENT_BUILD_JOB_NUMBER=$(curl -s https://mos.cci.in.here.com/job/$CUSTOM_CLIENT_BUILD_JOB/$CUSTOM_CLIENT_BUILD_JOB_NUMBER/buildNumber)
    fi
    echo CLIENT_BUILD_NUMBER=$CUSTOM_CLIENT_BUILD_JOB_NUMBER >> envs
else
    echo "Using default client build"
    echo CLIENT_BUILD_JOB=$BUILD_JOB_lin32_rel >> envs
    echo CLIENT_BUILD_NUMBER=$BUILD_NUMBER_lin32_rel >> envs
fi

# cleanup previous execution results
aws s3 rm --recursive s3://mitf-artifacts/mitf/success_geo_nodes-rc
aws s3 rm --recursive s3://mitf-artifacts/mitf/xml-rc
