#!groovy

// build description
currentBuild.description = "LDM: ${LDM_REGION_DVN} REFS: ${MITF_GERRIT_REFSPEC} | ${DESCRIPTION}"

stage ("Download Sources") {
    build job: "download-sources",
    parameters: [
        string(name: "USE_CACHE", value: "${USE_CACHE}"),
        string(name: "LDM_REGION_DVN", value: "${LDM_REGION_DVN}"),
        string(name: "MITF_GERRIT_REFSPEC", value: "${MITF_GERRIT_REFSPEC}")
    ]
}

stage ("Generate Acceptance Test Dumps") {
    build job: "generate-acc-test-cases",
    parameters: [
        string(name: "LDM_REGION_DVN", value: "${LDM_REGION_DVN}"),
        string(name: "MITF_GERRIT_REFSPEC", value: "${MITF_GERRIT_REFSPEC}"),
        string(name: "DESIRED_TC_QTY", value: "${DESIRED_TC_QTY}"),
        string(name: "GENERATORS", value: "${GENERATORS}")
    ]
}

stage ("Generate Keywords From Dumps") {
    build job: "generate-kwds-from-dumps",
    parameters: [
        string(name: "LDM_REGION_DVN", value: "${LDM_REGION_DVN}"),
        string(name: "MITF_GERRIT_REFSPEC", value: "${MITF_GERRIT_REFSPEC}"),
        string(name: "MAP_FORMAT", value: "${MAP_FORMAT}")
    ]
}

stage ("Download Map") {
    build job: "download-map",
    parameters: [
        string(name: "USE_CACHE", value: "True"),
        string(name: "MITF_GERRIT_REFSPEC", value: "${MITF_GERRIT_REFSPEC}"),
        string(name: "MAP_CONFIG_GERRIT_REFSPEC", value: "${MAP_CONFIG_GERRIT_REFSPEC}"),
        string(name: "MAP_FORMAT", value: "${MAP_FORMAT}")
    ]
}

stage ("Download Test Routing Component") {
        build job: "download-test-routing-component",
    parameters: [
        string(name: "MAP_FORMAT", value: "${MAP_FORMAT}"),
        string(name: "MITF_GERRIT_REFSPEC", value: "${MITF_GERRIT_REFSPEC}"),
        string(name: "SERVER_BUILD_JOB", value: "${SERVER_BUILD_JOB}"),
        string(name: "SERVER_BUILD_NUMBER", value: "${SERVER_BUILD_NUMBER}"),
    ]
}

stage ("Update Acceptance Tests") {
    try {
        build job: "generate-filtered-libs",
        parameters: [
            string(name: "MAP_FORMAT", value: "${MAP_FORMAT}"),
            string(name: "MITF_GERRIT_REFSPEC", value: "${MITF_GERRIT_REFSPEC}"),
            string(name: "MAP_CONFIG_GERRIT_REFSPEC", value: "${MAP_CONFIG_GERRIT_REFSPEC}"),
            string(name: "LDM_REGION_DVN", value: "${LDM_REGION_DVN}"),
        ]
    } catch(err) {
        if (currentBuild.result == 'UNSTABLE') {
            currentBuild.result == 'SUCCESS'
        }
    }
}

stage ("Cleanup Storage") {
    build job: "cleanup-storage",
    parameters: [
        string(name: "LDM_REGION_DVN", value: "${LDM_REGION_DVN}"),
        string(name: "MITF_GERRIT_REFSPEC", value: "${MITF_GERRIT_REFSPEC}")
    ],
    propagate: false
}
